!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).rexrestorabledataplugin=t()}(this,(function(){"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}function n(e){return(n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function o(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function a(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?o(e):t}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,r=n(e);if(t){var s=n(this).constructor;i=Reflect.construct(r,arguments,s)}else i=r.apply(this,arguments);return a(this,i)}}function u(e,t,i){return(u="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=n(e)););return e}(e,t);if(r){var s=Object.getOwnPropertyDescriptor(r,t);return s.get?s.get.call(i):s.value}})(e,t,i||e)}var l=function(e){if(Array.isArray(e))e.length=0;else for(var t in e)delete e[t]},c=Phaser.Data.DataManager,f=Phaser.Utils.Objects.GetValue,v=Phaser.Events.EventEmitter,_=function(t){r(a,t);var s=h(a);function a(t,i,r){var n;return e(this,a),void 0===i&&(i=new v),(n=s.call(this,t,i))._recordEnable=!0,n.resetFromJSON(r),n.events.on("changedata",n.onValueChange,o(n)).on("setdata",(function(e,t,i){this.onValueChange(e,t,i,null)}),o(n)).on("removedata",(function(e,t,i){this.onValueChange(e,t,null,i)}),o(n)),n}return i(a,[{key:"resetFromJSON",value:function(e){this._version=f(e,"version",0),this._versionAlias=f(e,"versionAlias",""),this._repository=f(e,"repository",[]),this._versionAliases=f(e,"versionAliases",{});var t=f(e,"changeList",{}),i=f(e,"data",void 0);if(i)this._recordEnable=!1,this.set(i),this._recordEnable=!0;else{var r=""!==this._versionAlias?this._versionAlias:this._version;for(var n in this._version=0,this.restore(r),this._recordEnable=!1,t)this.setValue(n,t[n][0]);this._recordEnable=!0}this._changeList=t}},{key:"toJSON",value:function(e){void 0===e&&(e=!1);var t={version:this._version,versionAlias:this._versionAlias,changeList:this._changeList,repository:this._repository,versionAliases:this._versionAliases};return e&&(t.data=this.list),t}},{key:"commit",value:function(e){for(var t in this._repository.length=this._version,this._versionAliases)this._versionAliases[t]>this._version&&delete this._versionAliases[t];return this._repository.push(this._changeList),this._changeList={},this._version++,"string"==typeof e&&(this._versionAlias=e,this._versionAliases[e]=this._version),this}},{key:"restore",value:function(e,t){return void 0===e&&(e=""!==this._versionAlias?this._versionAlias:this._version),void 0===t&&(t=!1),t&&(this.version=0),this.version=e,this}},{key:"reset",value:function(){return this.restore(0),this._repository.length=0,l(this._versionAliases),this}},{key:"onValueChange",value:function(e,t,i,r){this._recordEnable&&(this._changeList.hasOwnProperty(t)?this._changeList[t][0]=i:this._changeList[t]=[i,r])}},{key:"version",get:function(){return this._version},set:function(e){var t;if("string"==typeof e&&(t=e,e=this._versionAliases[e]),"number"==typeof e){if(this._versionAlias=t||"",0===e)return this._recordEnable=!1,u(n(a.prototype),"reset",this).call(this),this._version=0,l(this._changeList),void(this._recordEnable=!0);e=Math.min(e,this._repository.length);var i,r={};for(var s in this._changeList)r[s]=this._changeList[s][1],delete this._changeList[s];if(this._version===e);else if(this._version<e)for(var o=this._version;o<e;o++)for(var s in i=this._repository[o])r[s]=i[s][0];else for(o=this._version-1;o>=e;o--)for(var s in i=this._repository[o])r[s]=i[s][1];for(var s in this._version=e,this._recordEnable=!1,r)null===(e=r[s])?this.removeValue(s):this.setValue(s,e);this._recordEnable=!0}else this._versionAlias=""}},{key:"versionAlias",get:function(){return this._versionAlias}},{key:"lastVersion",get:function(){return this._repository.length}},{key:"versionAliases",get:function(){var e=[];for(var t in this._versionAliases)e.push(t);return e}}]),a}(c);return function(t){r(s,Phaser.Plugins.BasePlugin);var n=h(s);function s(t){return e(this,s),n.call(this,t)}return i(s,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this)}},{key:"add",value:function(e,t,i){return new _(e,t,i)}}]),s}()}));
